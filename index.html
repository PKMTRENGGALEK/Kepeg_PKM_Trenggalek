<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Cuti Pegawai</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.12/sweetalert2.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h2 class="mb-4">Form Cuti Pegawai</h2>
      <button id="logoutBtn">Logout</button>
      <form id="cutiForm">
        <div class="mb-3">
          <label for="tanggal" class="form-label">Tanggal</label>
          <input type="date" class="form-control" id="tanggal" readonly />
        </div>
        <div class="mb-3">
          <label for="nama" class="form-label">Nama</label>
          <input
            type="text"
            class="form-control"
            id="nama"
            placeholder="Masukkan Nama"
            required
          />
        </div>
        <div class="mb-3">
          <label for="nip" class="form-label">NIP</label>
          <input
            type="text"
            class="form-control"
            id="nip"
            placeholder="Masukkan NIP"
            required
          />
        </div>
        <div class="mb-3">
          <label for="tanggal_awal" class="form-label">Tanggal Cuti Awal</label>
          <input
            type="text"
            class="form-control datepicker"
            id="tanggal_awal"
            required
          />
        </div>
        <div class="mb-3">
          <label for="tanggal_akhir" class="form-label"
            >Tanggal Cuti Akhir</label
          >
          <input
            type="text"
            class="form-control datepicker"
            id="tanggal_akhir"
            required
          />
        </div>
        <div class="mb-3">
          <label for="lama_cuti" class="form-label">Lama Cuti (hari)</label>
          <input type="text" class="form-control" id="lama_cuti" readonly />
        </div>
        <div class="mb-3">
          <label for="keterangan" class="form-label">Keterangan Cuti</label>
          <textarea
            class="form-control"
            id="keterangan"
            rows="3"
            placeholder="Masukkan keterangan cuti"
          ></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
      // Cek apakah user sudah login
      if (!localStorage.getItem("username")) {
        window.location.href = "login.html"; // Redirect ke login jika belum login
      }
      document.getElementById("nama").value =
        localStorage.getItem("nama") || "";
      document.getElementById("nip").value = localStorage.getItem("nip") || "";
      flatpickr(".datepicker", {
        dateFormat: "Y-m-d",
        disableMobile: true,
      });

      // Set tanggal hari ini
      document.getElementById("tanggal").value = new Date()
        .toISOString()
        .split("T")[0];
      const tanggalAwalInput = document.getElementById("tanggal_awal");
      const tanggalAkhirInput = document.getElementById("tanggal_akhir");
      const lamaCutiInput = document.getElementById("lama_cuti");

      const tanggalMerah = ["2025-01-01", "2025-04-10", "2025-05-01"]; // Contoh tanggal merah

      function hitungLamaCuti() {
        const start = new Date(tanggalAwalInput.value);
        const end = new Date(tanggalAkhirInput.value);
        let count = 0;

        if (start && end && start <= end) {
          let currentDate = new Date(start);
          while (currentDate <= end) {
            if (
              currentDate.getDay() !== 0 &&
              !tanggalMerah.includes(currentDate.toISOString().split("T")[0])
            ) {
              count++;
            }
            currentDate.setDate(currentDate.getDate() + 1);
          }
        }
        lamaCutiInput.value = count;
      }

      tanggalAwalInput.addEventListener("change", hitungLamaCuti);
      tanggalAkhirInput.addEventListener("change", hitungLamaCuti);

      document
        .getElementById("cutiForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          var nama = document.getElementById("nama").value.trim();
          var nip = document.getElementById("nip").value.trim();
          var tanggal_awal = document.getElementById("tanggal_awal").value;
          var tanggal_akhir = document.getElementById("tanggal_akhir").value;
          var keterangan = document.getElementById("keterangan").value.trim();
          var lama_cuti = document.getElementById("lama_cuti").value.trim();

          // Validasi Input
          if (
            !nama ||
            !nip ||
            !tanggal_awal ||
            !tanggal_akhir ||
            !keterangan ||
            !lama_cuti
          ) {
            Swal.fire({
              icon: "warning",
              title: "Oops...",
              text: "Semua kolom harus diisi!",
              backdrop: "rgba(0,0,0,0.4)",
              allowOutsideClick: false,
            });
            return;
          }

          // Tampilkan loading saat fetch berjalan
          Swal.fire({
            title: "Mengirim Data...",
            html: "Harap tunggu sebentar",
            allowOutsideClick: false,
            backdrop: "rgba(0,0,0,0.4)",
            didOpen: () => {
              Swal.showLoading();
            },
          });

          var formData = new FormData();
          formData.append("nama", nama);
          formData.append("nip", nip);
          formData.append("tanggal_cuti_awal", tanggal_awal);
          formData.append("tanggal_cuti_akhir", tanggal_akhir);
          formData.append("keterangan", keterangan);
          formData.append("lama_cuti", lama_cuti);

          fetch(
            "https://script.google.com/macros/s/AKfycbz8-nYf_varVN74sug2MqtwFuu2gnPzMYR7DuGfvl44gcgV-PCZtMRLSUB4HD4UktrTiA/exec",
            {
              method: "POST",
              body: formData,
            }
          )
            .then((response) => response.text()) // Ambil response sebagai teks dulu
            .then((text) => {
              try {
                return JSON.parse(text); // Coba parse ke JSON
              } catch (error) {
                throw new Error("Invalid JSON: " + text);
              }
            })
            .then((data) => {
              Swal.close(); // Tutup loading

              if (data.status === "success") {
                Swal.fire({
                  icon: "success",
                  title: "Berhasil!",
                  text: "Data berhasil dikirim ke Spreadsheet!",
                  backdrop: "rgba(0,0,0,0.4)",
                  allowOutsideClick: false,
                }).then(() => {
                  document.getElementById("cutiForm").reset();
                });
              } else {
                Swal.fire({
                  icon: "error",
                  title: "Gagal!",
                  text: "Terjadi kesalahan: " + data.message,
                  backdrop: "rgba(0,0,0,0.4)",
                  allowOutsideClick: false,
                });
              }
            })
            .catch((error) => {
              Swal.close(); // Tutup loading

              Swal.fire({
                icon: "error",
                title: "Kesalahan!",
                text: "Gagal mengirim data. Coba lagi nanti!\n" + error.message,
                backdrop: "rgba(0,0,0,0.4)",
                allowOutsideClick: false,
              });

              console.error("Error:", error);
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.12/sweetalert2.all.min.js"></script>
  </body>
</html>
<script>
  // Cek apakah user sudah login
  if (!localStorage.getItem("username")) {
    window.location.href = "login.html"; // Redirect ke login jika belum login
  }
</script>
<script>
  document.getElementById("logoutBtn").addEventListener("click", function () {
    localStorage.removeItem("username"); // Hapus session
    window.location.href = "login.html"; // Redirect ke halaman login
  });
</script>
